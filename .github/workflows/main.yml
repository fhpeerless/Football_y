name: Football Prediction Pipeline

on:
  schedule:
    # 北京时间 6:00, 12:00, 18:00, 24:00 (0:00) 执行
    # cron 格式: 分 时 日 月 星期
    - cron: '0 6,12,18,0 * * *'
      timezone: 'Asia/Shanghai'
  workflow_dispatch:  # 允许手动触发
    inputs:
      period:
        description: '期数 (可选)'
        required: false
        type: string

jobs:
  check-and-process:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 已正确配置写入权限，保留
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        persist-credentials: true
        fetch-depth: 0  # 已正确配置完整克隆，保留
      
    - name: 设置 Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: 设置 Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: 安装 Python 依赖
      run: |
        pip install requests numpy
        
    - name: 检查是否有新期数
      id: check-period
      run: |
        echo "正在检查新期数..."
        # 运行脚本，脚本会设置 has_new_period 输出（true/false）
        node check_new_period.js
        
    - name: 环境验证和调试
      if: steps.check-period.outputs.has_new_period == 'true'
      run: |
        echo "=== 调试信息开始 ==="
        echo "当前工作目录: $(pwd)"
        echo "目录结构:"
        ls -la
        
        # 创建result目录并设置权限
        echo "创建result目录..."
        mkdir -p ./result
        chmod 755 ./result
        echo "result目录状态:"
        ls -ld ./result
        
        echo "Python版本: $(python --version)"
        echo "Node.js版本: $(node --version)"
        
        # 检查Python包
        echo "已安装Python包:"
        pip list | grep -E "requests|numpy" || echo "未找到相关包"
        
        echo "=== 调试信息结束 ==="
        
    - name: 运行 API 爬虫 (获取比赛数据)
      if: steps.check-period.outputs.has_new_period == 'true'
      run: |
        echo "=== API爬虫步骤开始 ==="
        echo "正在运行 API 爬虫获取比赛数据..."
        
        # 尝试最多3次
        for i in {1..3}; do
          echo "第 $i 次尝试..."
          if python api_crawler_final.py; then
            echo "API爬虫执行成功"
            
            # 检查是否生成了文件
            echo "检查生成的文件..."
            ls -la ./result/ 2>/dev/null || echo "result目录不存在"
            
            # 显示生成的文件内容（前100个字符）
            if [ -d "./result" ]; then
              for file in ./result/*.json; do
                if [ -f "$file" ]; then
                  echo "文件: $file"
                  echo "前100字符: $(head -c 100 "$file")"
                fi
              done
            fi
            
            exit 0
          else
            echo "第 $i 次尝试失败"
            if [ $i -lt 3 ]; then
              echo "等待5秒后重试..."
              sleep 5
            fi
          fi
        done
        
        echo "API爬虫所有尝试均失败"
        echo "=== API爬虫步骤结束 ==="
        exit 1
        
    - name: 获取历史交锋数据
      if: steps.check-period.outputs.has_new_period == 'true'
      run: |
        echo "=== 历史交锋数据步骤开始 ==="
        echo "正在获取历史交锋数据..."
        
        # 检查必要的输入文件
        echo "检查result目录内容:"
        ls -la ./result/ 2>/dev/null || echo "result目录不存在"
        
        # 运行脚本
        if python get_history_data.py; then
          echo "历史交锋数据获取成功"
          
          # 验证输出文件
          echo "检查生成的文件..."
          if [ -d "./result" ]; then
            echo "result目录中的文件:"
            ls -la ./result/
            
            # 检查是否有历史交锋文件
            history_files=$(find ./result -name "*历史交锋.json" -type f)
            if [ -n "$history_files" ]; then
              echo "找到历史交锋文件:"
              for file in $history_files; do
                echo "  $file"
                echo "  文件大小: $(wc -c < "$file") 字节"
              done
            else
              echo "警告: 未找到历史交锋文件"
            fi
          fi
          
          echo "=== 历史交锋数据步骤结束 ==="
          exit 0
        else
          echo "历史交锋数据获取失败"
          echo "=== 历史交锋数据步骤结束 ==="
          exit 1
        fi
        
    - name: 计算基础预测概率
      if: steps.check-period.outputs.has_new_period == 'true'
      run: |
        echo "正在计算基础预测概率..."
        python calculate_probability.py
        
    - name: 计算高级预测概率
      if: steps.check-period.outputs.has_new_period == 'true'
      run: |
        echo "正在计算高级预测概率..."
        python calculate_advanced_probability.py
        
    - name: 计算共同对手实力分
      if: steps.check-period.outputs.has_new_period == 'true'
      run: |
        echo "正在计算共同对手实力分..."
        python calculate_common_opponent_strength.py
        
    - name: 合并预测概率
      if: steps.check-period.outputs.has_new_period == 'true'
      run: |
        echo "正在合并预测概率..."
        node combine_probability.js
        
    - name: 验证最终结果
      if: steps.check-period.outputs.has_new_period == 'true'
      run: |
        echo "=== 验证最终结果开始 ==="
        echo "检查所有生成的文件..."
        
        if [ -d "./result" ]; then
          echo "result目录内容:"
          ls -la ./result/
          
          echo "文件统计:"
          echo "总文件数: $(find ./result -type f | wc -l)"
          
          # 检查关键文件
          key_files=("*_web.json" "*_预测概率.json" "*_高级预测概率.json" "*_共同对手实力分.json" "*_历史交锋.json" "*.json")
          
          for pattern in "${key_files[@]}"; do
            files=$(find ./result -name "$pattern" -type f)
            if [ -n "$files" ]; then
              echo "找到 $pattern 文件:"
              for file in $files; do
                echo "  - $file ($(wc -c < "$file") 字节)"
              done
            else
              echo "警告: 未找到 $pattern 文件"
            fi
          done
          
          # 检查web.json文件内容
          web_files=$(find ./result -name "*_web.json" -type f)
          if [ -n "$web_files" ]; then
            echo "web.json文件内容摘要:"
            for file in $web_files; do
              echo "文件: $file"
              echo "期数: $(grep -o '"期数":"[^"]*"' "$file" | head -1 || echo '未找到')"
              echo "比赛数: $(grep -o '"计算结果":\[.*\]' "$file" | grep -o '},{' | wc -l | awk '{print $1+1}' || echo '0')"
            done
          fi
        else
          echo "错误: result目录不存在"
        fi
        
        echo "=== 验证最终结果结束 ==="
        
    - name: 上传结果文件
      if: steps.check-period.outputs.has_new_period == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: prediction-results
        path: result/
        retention-days: 7
        
    - name: 提交结果到仓库
      if: steps.check-period.outputs.has_new_period == 'true'
      run: |
        # 修复1：使用正确的邮箱格式（官方推荐）
        git config --global user.name "GitHub Actions"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # 添加result目录下的所有文件
        git add result/
        
        # 修复2：优化commit容错（避免无更改时报错）
        git commit -m "添加预测结果文件 [skip ci]" || {
          echo "没有更改可提交，跳过push步骤"
          exit 0  # 无更改时正常退出，不影响工作流
        }
        
        # 修复3：使用正确的Git Push URL格式（核心修复）
        # 格式：https://<token>@github.com/<owner>/<repo>.git
        git push "https://${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" "HEAD:${{ github.ref_name }}"
        
        # 可选：添加push失败重试（增强稳定性）
        if [ $? -ne 0 ]; then
          echo "第一次push失败，等待3秒后重试..."
          sleep 3
          git push "https://${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" "HEAD:${{ github.ref_name }}"
        fi
