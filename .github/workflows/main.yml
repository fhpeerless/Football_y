name: Football Prediction Pipeline

on:
  schedule:
    # 北京时间 6:00, 12:00, 18:00, 24:00 (0:00) 执行
    # cron 格式: 分 时 日 月 星期
    - cron: '0 6,12,18,0 * * *'
      timezone: 'Asia/Shanghai'
  workflow_dispatch:  # 允许手动触发
    inputs:
      period:
        description: '期数 (可选)'
        required: false
        type: string

jobs:
  check-and-process:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置 Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: 设置 Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: 安装 Python 依赖
      run: |
        pip install requests numpy
        
    - name: 检查是否有新期数
      id: check-period
      run: |
        echo "正在检查新期数..."
        node check_new_period.js
        EXIT_CODE=$?
        echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
        if [ $EXIT_CODE -eq 1 ]; then
          echo "检测到新期数，继续执行后续步骤"
        else
          echo "无新期数，跳过后续步骤"
        fi
        
    - name: 运行 API 爬虫 (获取比赛数据)
      if: steps.check-period.outputs.exit_code == '1'
      run: |
        echo "正在运行 API 爬虫获取比赛数据..."
        python api_crawler_final.py
        
    - name: 获取历史交锋数据
      if: steps.check-period.outputs.exit_code == '1'
      run: |
        echo "正在获取历史交锋数据..."
        python get_history_data.py
        
    - name: 计算基础预测概率
      if: steps.check-period.outputs.exit_code == '1'
      run: |
        echo "正在计算基础预测概率..."
        python calculate_probability.py
        
    - name: 计算高级预测概率
      if: steps.check-period.outputs.exit_code == '1'
      run: |
        echo "正在计算高级预测概率..."
        python calculate_advanced_probability.py
        
    - name: 合并预测概率
      if: steps.check-period.outputs.exit_code == '1'
      run: |
        echo "正在合并预测概率..."
        node combine_probability.js
        
    - name: 上传结果文件
      if: steps.check-period.outputs.exit_code == '1'
      uses: actions/upload-artifact@v4
      with:
        name: prediction-results
        path: result/
        retention-days: 7
