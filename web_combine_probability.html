<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>足球预测概率查看器（Web JSON数据）</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a237e 0%, #311b92 100%);
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, #00bcd4, #8e24aa);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.8;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
        }
        
        .control-panel {
            background: rgba(255, 255, 255, 0.08);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        .results-panel {
            background: rgba(255, 255, 255, 0.08);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            overflow: auto;
            max-height: 70vh;
        }
        
        .section-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: #00bcd4;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            font-size: 1.6rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #bbdefb;
        }
        
        input, select, button {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #00bcd4;
            box-shadow: 0 0 0 2px rgba(0, 188, 212, 0.2);
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }
        
        button {
            background: linear-gradient(135deg, #00bcd4 0%, #00838f 100%);
            border: none;
            cursor: pointer;
            font-weight: 600;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 188, 212, 0.3);
        }
        
        button.secondary {
            background: linear-gradient(135deg, #8e24aa 0%, #6a1b9a 100%);
        }
        
        button.secondary:hover {
            box-shadow: 0 8px 20px rgba(142, 36, 170, 0.3);
        }
        
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            display: none;
        }
        
        .status.success {
            background: rgba(76, 175, 80, 0.2);
            border-left: 4px solid #4caf50;
            display: block;
        }
        
        .status.error {
            background: rgba(244, 67, 54, 0.2);
            border-left: 4px solid #f44336;
            display: block;
        }
        
        .status.info {
            background: rgba(33, 150, 243, 0.2);
            border-left: 4px solid #2196f3;
            display: block;
        }
        
        .matches-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .matches-table th {
            background: rgba(0, 188, 212, 0.3);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .matches-table td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .matches-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .result-3 {
            color: #4caf50;
            font-weight: bold;
        }
        
        .result-1 {
            color: #ff9800;
            font-weight: bold;
        }
        
        .result-0 {
            color: #f44336;
            font-weight: bold;
        }
        
        .progress-bar {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00bcd4, #8e24aa);
            width: 0%;
            transition: width 0.5s;
        }
        
        .download-link {
            display: inline-block;
            margin-top: 20px;
            padding: 12px 25px;
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .download-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 152, 0, 0.3);
        }
        
        .file-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .file-input-group input[type="file"] {
            flex: 1;
        }
        
        .file-input-group button {
            width: auto;
            padding: 12px 20px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2rem;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-futbol"></i> 足球预测概率合并工具</h1>
            <p class="subtitle">查看已生成的预测概率合并结果（web.json数据）</p>
        </header>
        
        <div class="main-content">
            <div class="control-panel">
                <h2 class="section-title"><i class="fas fa-sliders-h"></i> 控制面板</h2>
                
                <div class="form-group">
                    <label for="periodInput"><i class="fas fa-calendar-alt"></i> 当前期数</label>
                    <div class="file-input-group">
                        <input type="text" id="periodInput" placeholder="例如：26027" value="26027">
                        <button id="fetchPeriodBtn" class="secondary">
                            <i class="fas fa-sync-alt"></i> 获取期数
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-database"></i> 数据文件</label>
                    <div class="btn-group" style="margin-top: 10px;">
                        <button id="loadWebDataBtn">
                            <i class="fas fa-file-import"></i> 加载Web数据
                        </button>
                        <button id="downloadBtn" class="secondary">
                            <i class="fas fa-download"></i> 下载JSON
                        </button>
                    </div>
                    <p style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">
                        将自动加载 ./result/{期数}期_web.json 文件
                    </p>
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                
                <div class="status" id="statusMessage">
                    <!-- 状态消息将显示在这里 -->
                </div>
            </div>
            
            <div class="results-panel">
                <h2 class="section-title"><i class="fas fa-list-alt"></i> 计算结果</h2>
                
                <div id="resultsContainer">
                    <p style="text-align: center; opacity: 0.7; padding: 40px;">
                        请先获取期数，然后点击"加载Web数据"按钮查看预测结果
                    </p>
                </div>
                
                <a href="#" id="downloadLink" class="download-link" style="display: none;">
                    <i class="fas fa-file-download"></i> 下载合并结果 (JSON)
                </a>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentPeriod = '';
        let webData = null;
        
        // DOM元素
        const periodInput = document.getElementById('periodInput');
        const fetchPeriodBtn = document.getElementById('fetchPeriodBtn');
        const loadWebDataBtn = document.getElementById('loadWebDataBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const downloadLink = document.getElementById('downloadLink');
        const statusMessage = document.getElementById('statusMessage');
        const progressFill = document.getElementById('progressFill');
        const resultsContainer = document.getElementById('resultsContainer');
        
        // 显示状态消息
        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = `status ${type}`;
            setTimeout(() => {
                statusMessage.className = 'status';
            }, type === 'error' ? 5000 : 3000);
        }
        
        // 更新进度条
        function updateProgress(percent) {
            progressFill.style.width = `${percent}%`;
        }
        
        // 获取当前期数
        async function fetchCurrentPeriod() {
            try {
                showStatus('正在获取当前期数...', 'info');
                updateProgress(30);
                
                // 尝试从API获取期数
                const timestamp = Date.now();
                const apiUrl = `https://ews.500.com/score/zq/info?vtype=sfc&expect=&_t=${timestamp}`;
                
                // 添加CORS代理以避免跨域问题
                const proxyUrl = `https://cors-anywhere.herokuapp.com/${apiUrl}`;
                
                let period = '';
                let useProxy = false;
                
                try {
                    // 首先尝试直接调用API（可能因CORS失败）
                    const response = await fetch(apiUrl, {
                        headers: {
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                            'Accept': 'application/json, text/javascript, */*; q=0.01',
                            'Referer': 'https://yllive-m.500.com/home/zq/sfc/cur'
                        },
                        mode: 'cors'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        period = data?.data?.curr_expect || '';
                    }
                } catch (directError) {
                    console.log('直接API调用失败，尝试使用CORS代理:', directError.message);
                    useProxy = true;
                }
                
                // 如果直接调用失败，尝试使用CORS代理
                if (!period && useProxy) {
                    try {
                        const proxyResponse = await fetch(proxyUrl, {
                            headers: {
                                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                                'Accept': 'application/json, text/javascript, */*; q=0.01',
                                'Referer': 'https://yllive-m.500.com/home/zq/sfc/cur',
                                'Origin': 'https://yllive-m.500.com'
                            }
                        });
                        
                        if (proxyResponse.ok) {
                            const data = await proxyResponse.json();
                            period = data?.data?.curr_expect || '';
                        }
                    } catch (proxyError) {
                        console.log('CORS代理也失败:', proxyError.message);
                    }
                }
                
                // 如果API获取失败，检查是否已有web.json文件
                if (!period) {
                    // 尝试从26027开始向后查找可用的web.json文件
                    for (let testPeriod = 26027; testPeriod >= 26000; testPeriod--) {
                        const testUrl = `./result/${testPeriod}期_web.json`;
                        try {
                            const testResponse = await fetch(testUrl);
                            if (testResponse.ok) {
                                period = testPeriod.toString();
                                console.log(`从文件系统找到最新期数: ${period}`);
                                break;
                            }
                        } catch (e) {
                            // 继续尝试下一个期数
                        }
                    }
                }
                
                if (period) {
                    currentPeriod = period.toString();
                    periodInput.value = currentPeriod;
                    updateProgress(100);
                    showStatus(`成功获取当前期数: ${currentPeriod}期`, 'success');
                    
                    // 获取期数后自动加载web.json数据
                    setTimeout(() => {
                        loadWebDataBtn.click();
                    }, 500);
                    
                    return currentPeriod;
                } else {
                    // 使用模拟数据作为最后的手段
                    currentPeriod = '26027';
                    periodInput.value = currentPeriod;
                    updateProgress(100);
                    showStatus(`使用默认期数: ${currentPeriod}期`, 'info');
                    return currentPeriod;
                }
            } catch (error) {
                console.error('获取期数错误:', error);
                updateProgress(0);
                showStatus(`获取期数失败: ${error.message}，请手动输入期数`, 'error');
                return null;
            }
        }
        
        // 读取JSON文件（从文件输入）
        function readJSONFile(file) {
            return new Promise((resolve, reject) => {
                if (!file) {
                    reject(new Error('请选择文件'));
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        resolve(data);
                    } catch (error) {
                        reject(new Error('文件格式错误，不是有效的JSON'));
                    }
                };
                
                reader.onerror = function() {
                    reject(new Error('读取文件失败'));
                };
                
                reader.readAsText(file);
            });
        }
        
        // 加载Web JSON数据
        async function loadWebData() {
            if (!currentPeriod) {
                showStatus('请先获取或输入期数', 'error');
                return null;
            }
            
            try {
                showStatus(`正在加载 ${currentPeriod}期_web.json 文件...`, 'info');
                updateProgress(40);
                
                const fileUrl = `./result/${currentPeriod}期_web.json`;
                console.log(`正在加载: ${fileUrl}`);
                
                const response = await fetch(fileUrl);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error(`文件不存在: ${fileUrl}，请确保已生成该文件`);
                    } else {
                        throw new Error(`HTTP错误: ${response.status} ${response.statusText}`);
                    }
                }
                
                const data = await response.json();
                updateProgress(80);
                
                // 验证数据格式
                if (!data.期数 || !data.计算结果 || !Array.isArray(data.计算结果)) {
                    throw new Error('web.json文件格式不正确');
                }
                
                webData = data;
                updateProgress(100);
                showStatus(`成功加载 ${data.计算结果.length} 场比赛数据`, 'success');
                
                // 显示结果
                displayResults();
                
                // 生成下载链接
                generateDownloadLink();
                
                return webData;
            } catch (error) {
                console.error('加载Web数据错误:', error);
                updateProgress(0);
                showStatus(`加载失败: ${error.message}`, 'error');
                
                // 如果文件不存在，提示用户
                if (error.message.includes('文件不存在')) {
                    showStatus(`请先运行 combine_probability.js 生成 ${currentPeriod}期_web.json 文件`, 'error');
                }
                
                return null;
            }
        }
        

        
        // 从概率字符串中提取数字（如"45.68%" -> 0.4568）（保留用于可能的数据转换）
        function parseProbability(probStr) {
            if (typeof probStr === 'number') return probStr;
            if (typeof probStr === 'string') {
                const match = probStr.match(/(\d+\.?\d*)/);
                return match ? parseFloat(match[1]) / 100 : 0;
            }
            return 0;
        }
        
        // 显示计算结果
        function displayResults() {
            if (!webData || !webData.计算结果 || webData.计算结果.length === 0) {
                resultsContainer.innerHTML = `
                    <p style="text-align: center; opacity: 0.7; padding: 40px;">
                        暂无数据，请先加载Web JSON数据
                    </p>
                `;
                return;
            }
            
            let html = `
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                    <h3 style="color: #00bcd4; margin-bottom: 10px;">数据信息</h3>
                    <p><strong>期数:</strong> ${webData.期数 || '未知'}</p>
                    <p><strong>生成时间:</strong> ${webData.生成时间 ? new Date(webData.生成时间).toLocaleString() : '未知'}</p>
                    <p><strong>数据来源:</strong> ${webData.数据来源 ? `${webData.数据来源.基础预测文件} + ${webData.数据来源.高级预测文件}` : 'web.json文件'}</p>
                    <p><strong>加权规则:</strong> ${webData.加权规则 || '基础预测概率 × 0.8 + 高级预测概率'}</p>
                </div>
                <table class="matches-table">
                    <thead>
                        <tr>
                            <th>场次</th>
                            <th>联赛</th>
                            <th>主队</th>
                            <th>客队</th>
                            <th>比赛时间</th>
                            <th>合并胜率</th>
                            <th>合并平率</th>
                            <th>合并负率</th>
                            <th>预测结果</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            webData.计算结果.forEach(match => {
                const winPercent = (match.合并概率.胜 * 100).toFixed(1);
                const drawPercent = (match.合并概率.平 * 100).toFixed(1);
                const losePercent = (match.合并概率.负 * 100).toFixed(1);
                const resultClass = `result-${match.预测结果}`;
                const resultText = match.预测结果 === 3 ? '主胜(3)' : match.预测结果 === 1 ? '平(1)' : '客胜(0)';
                
                html += `
                    <tr>
                        <td>${match.场次}</td>
                        <td>${match.联赛}</td>
                        <td><strong>${match.主队}</strong></td>
                        <td>${match.客队}</td>
                        <td>${match.比赛时间}</td>
                        <td>${winPercent}%</td>
                        <td>${drawPercent}%</td>
                        <td>${losePercent}%</td>
                        <td class="${resultClass}">${resultText}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                <div style="margin-top: 20px; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                    <h3 style="color: #00bcd4; margin-bottom: 10px;">预测结果汇总</h3>
                    <p>总场次: ${webData.计算结果.length}</p>
                    <p>主胜(3): ${webData.计算结果.filter(m => m.预测结果 === 3).length} 场</p>
                    <p>平(1): ${webData.计算结果.filter(m => m.预测结果 === 1).length} 场</p>
                    <p>客胜(0): ${webData.计算结果.filter(m => m.预测结果 === 0).length} 场</p>
                </div>
            `;
            
            resultsContainer.innerHTML = html;
            downloadLink.style.display = 'inline-block';
        }
        
        // 生成下载链接
        function generateDownloadLink() {
            if (!webData) {
                showStatus('没有可下载的数据', 'error');
                return;
            }
            
            try {
                const jsonData = JSON.stringify(webData, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const period = webData.期数?.replace('期', '') || currentPeriod || '未知期数';
                downloadLink.href = url;
                downloadLink.download = `${period}期_web.json`;
                downloadLink.textContent = `下载Web数据 (${period}期_web.json)`;
                
                // 清理之前的URL
                setTimeout(() => URL.revokeObjectURL(url), 60000);
                
                showStatus('下载链接已生成，点击"下载JSON"按钮保存文件', 'success');
            } catch (error) {
                console.error('生成下载链接错误:', error);
                showStatus(`生成下载链接失败: ${error.message}`, 'error');
            }
        }
        
        // 事件监听器
        fetchPeriodBtn.addEventListener('click', fetchCurrentPeriod);
        
        loadWebDataBtn.addEventListener('click', async () => {
            const data = await loadWebData();
            if (data) {
                console.log('Web数据加载成功:', data);
            }
        });
        
        downloadBtn.addEventListener('click', () => {
            if (downloadLink.href && downloadLink.href !== '#') {
                downloadLink.click();
            } else {
                showStatus('请先加载Web数据以生成下载文件', 'error');
            }
        });
        
        // 期数输入框支持回车键
        periodInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                currentPeriod = periodInput.value.trim();
                if (currentPeriod) {
                    showStatus(`已手动设置期数为: ${currentPeriod}期`, 'info');
                    // 自动加载数据
                    setTimeout(() => {
                        loadWebDataBtn.click();
                    }, 300);
                }
            }
        });
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            showStatus('Web数据查看器已加载完成，正在自动获取期数...', 'info');
            updateProgress(0);
            
            // 尝试自动获取期数（获取后会自动加载web.json数据）
            fetchCurrentPeriod();
        });
        

    </script>
</body>
</html>