<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>足球预测概率查看器（Web JSON数据1）</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a237e 0%, #311b92 100%);
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, #00bcd4, #8e24aa);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.8;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        
        .control-panel {
            background: rgba(255, 255, 255, 0.08);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        .results-panel {
            background: rgba(255, 255, 255, 0.08);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            overflow: auto;
            max-height: 70vh;
        }
        
        .section-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: #00bcd4;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            font-size: 1.6rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #bbdefb;
        }
        
        input, select, button {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #00bcd4;
            box-shadow: 0 0 0 2px rgba(0, 188, 212, 0.2);
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }
        
        button {
            background: linear-gradient(135deg, #00bcd4 0%, #00838f 100%);
            border: none;
            cursor: pointer;
            font-weight: 600;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 188, 212, 0.3);
        }
        
        button.secondary {
            background: linear-gradient(135deg, #8e24aa 0%, #6a1b9a 100%);
        }
        
        button.secondary:hover {
            box-shadow: 0 8px 20px rgba(142, 36, 170, 0.3);
        }
        
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            display: none;
        }
        
        .status.success {
            background: rgba(76, 175, 80, 0.2);
            border-left: 4px solid #4caf50;
            display: block;
        }
        
        .status.error {
            background: rgba(244, 67, 54, 0.2);
            border-left: 4px solid #f44336;
            display: block;
        }
        
        .status.info {
            background: rgba(33, 150, 243, 0.2);
            border-left: 4px solid #2196f3;
            display: block;
        }
        
        .matches-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .matches-table th {
            background: rgba(0, 188, 212, 0.3);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .matches-table td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .matches-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .result-3 {
            color: #4caf50;
            font-weight: bold;
        }
        
        .result-1 {
            color: #ff9800;
            font-weight: bold;
        }
        
        .result-0 {
            color: #f44336;
            font-weight: bold;
        }
        
        .progress-bar {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00bcd4, #8e24aa);
            width: 0%;
            transition: width 0.5s;
        }
        
        .download-link {
            display: inline-block;
            margin-top: 20px;
            padding: 12px 25px;
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .download-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 152, 0, 0.3);
        }
        
        .file-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .file-input-group input[type="file"] {
            flex: 1;
        }
        
        .file-input-group button {
            width: auto;
            padding: 12px 20px;
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-futbol"></i> 足球预测概率合并工具</h1>
            <p class="subtitle">查看已生成的预测概率合并结果（web.json数据）</p>
        </header>
        
        <div class="main-content">
            <div class="control-panel">
                <h2 class="section-title"><i class="fas fa-sliders-h"></i> 控制面板</h2>
                
                <div class="form-group">
                    <label for="periodInput"><i class="fas fa-calendar-alt"></i> 当前期数</label>
                    <div class="file-input-group">
                        <input type="text" id="periodInput" placeholder="例如：26027" value="26027">
                        <button id="fetchPeriodBtn" class="secondary">
                            <i class="fas fa-sync-alt"></i> 获取期数
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-database"></i> 数据文件</label>
                    <div class="btn-group" style="margin-top: 10px;">
                        <button id="loadWebDataBtn">
                            <i class="fas fa-file-import"></i> 加载Web数据
                        </button>
                        <button id="downloadBtn" class="secondary">
                            <i class="fas fa-download"></i> 号码结果
                        </button>
                    </div>
                    <p style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">
                        将自动加载 ./result/{期数}期_web.json 文件
                    </p>
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                
                <div class="status" id="statusMessage">
                    <!-- 状态消息将显示在这里 -->
                </div>
            </div>
            
            <div class="results-panel">
                <h2 class="section-title"><i class="fas fa-list-alt"></i> 计算结果</h2>
                
                <div id="resultsContainer">
                    <p style="text-align: center; opacity: 0.7; padding: 40px;">
                        请先获取期数，然后点击"加载Web数据"按钮查看预测结果
                    </p>
                </div>
                
                <a href="#" id="downloadLink" class="download-link" style="display: none;">
                    <i class="fas fa-file-download"></i> 下载合并结果 (JSON)
                </a>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentPeriod = '';
        let webData = null;
        
        // DOM元素
        const periodInput = document.getElementById('periodInput');
        const fetchPeriodBtn = document.getElementById('fetchPeriodBtn');
        const loadWebDataBtn = document.getElementById('loadWebDataBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const downloadLink = document.getElementById('downloadLink');
        const statusMessage = document.getElementById('statusMessage');
        const progressFill = document.getElementById('progressFill');
        const resultsContainer = document.getElementById('resultsContainer');
        
        // 显示状态消息
        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = `status ${type}`;
            setTimeout(() => {
                statusMessage.className = 'status';
            }, type === 'error' ? 5000 : 3000);
        }
        
        // 更新进度条
        function updateProgress(percent) {
            progressFill.style.width = `${percent}%`;
        }
        
        // 获取当前期数
        async function fetchCurrentPeriod() {
            try {
                showStatus('正在从present.json获取当前期数...', 'info');
                updateProgress(30);
                
                let period = '';
                
                try {
                    // 尝试从./present.json文件获取期数
                    const response = await fetch('./present.json');
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        // 验证数据格式
                        if (Array.isArray(data) && data.length > 0) {
                            // 获取最后一个条目的期数（最新期数）
                            const lastEntry = data[data.length - 1];
                            period = lastEntry.period || lastEntry.period_number?.toString() || '';
                            
                            if (period) {
                                console.log(`从present.json获取到最新期数: ${period}`);
                            }
                        } else {
                            console.log('present.json格式不正确或为空数组');
                        }
                    } else {
                        console.log(`无法读取present.json文件: HTTP ${response.status}`);
                    }
                } catch (fileError) {
                    console.log('读取present.json文件失败:', fileError.message);
                }
                
                // 如果从present.json获取失败，检查是否已有web.json文件
                if (!period) {
                    console.log('尝试从web.json文件查找最新期数...');
                    // 尝试从26027开始向后查找可用的web.json文件
                    for (let testPeriod = 26027; testPeriod >= 26000; testPeriod--) {
                        const testUrl = `./result/${testPeriod}期_web.json`;
                        try {
                            const testResponse = await fetch(testUrl);
                            if (testResponse.ok) {
                                period = testPeriod.toString();
                                console.log(`从文件系统找到最新期数: ${period}`);
                                break;
                            }
                        } catch (e) {
                            // 继续尝试下一个期数
                        }
                    }
                }
                
                if (period) {
                    currentPeriod = period.toString();
                    periodInput.value = currentPeriod;
                    updateProgress(100);
                    showStatus(`成功获取当前期数: ${currentPeriod}期`, 'success');
                    
                    // 获取期数后自动加载web.json数据
                    setTimeout(() => {
                        loadWebDataBtn.click();
                    }, 500);
                    
                    return currentPeriod;
                } else {
                    // 使用模拟数据作为最后的手段
                    currentPeriod = '26027';
                    periodInput.value = currentPeriod;
                    updateProgress(100);
                    showStatus(`使用默认期数: ${currentPeriod}期`, 'info');
                    return currentPeriod;
                }
            } catch (error) {
                console.error('获取期数错误:', error);
                updateProgress(0);
                showStatus(`获取期数失败: ${error.message}，请手动输入期数`, 'error');
                return null;
            }
        }
        
        // 读取JSON文件（从文件输入）
        function readJSONFile(file) {
            return new Promise((resolve, reject) => {
                if (!file) {
                    reject(new Error('请选择文件'));
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        resolve(data);
                    } catch (error) {
                        reject(new Error('文件格式错误，不是有效的JSON'));
                    }
                };
                
                reader.onerror = function() {
                    reject(new Error('读取文件失败'));
                };
                
                reader.readAsText(file);
            });
        }
        
        // 加载Web JSON数据
        async function loadWebData() {
            // 从输入框读取当前期数
            const inputPeriod = periodInput.value.trim();
            if (inputPeriod) {
                // 提取数字部分（例如从"26027期"中提取"26027"）
                const periodMatch = inputPeriod.match(/\d+/);
                if (periodMatch) {
                    currentPeriod = periodMatch[0];
                } else {
                    currentPeriod = inputPeriod;
                }
            }
            
            if (!currentPeriod) {
                showStatus('请先获取或输入期数', 'error');
                return null;
            }
            
            try {
                showStatus(`正在加载 ${currentPeriod}期_web.json 文件...`, 'info');
                updateProgress(40);
                
                const fileUrl = `./result/${currentPeriod}期_web.json`;
                console.log(`正在加载: ${fileUrl}`);
                
                const response = await fetch(fileUrl);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error(`文件不存在: ${fileUrl}，请确保已生成该文件`);
                    } else {
                        throw new Error(`HTTP错误: ${response.status} ${response.statusText}`);
                    }
                }
                
                const data = await response.json();
                updateProgress(80);
                
                // 验证数据格式
                if (!data.期数 || !data.计算结果 || !Array.isArray(data.计算结果)) {
                    throw new Error('web.json文件格式不正确');
                }
                
                webData = data;
                updateProgress(100);
                showStatus(`成功加载 ${data.计算结果.length} 场比赛数据`, 'success');
                
                // 显示结果
                displayResults();
                
                // 生成下载链接
                generateDownloadLink();
                
                return webData;
            } catch (error) {
                console.error('加载Web数据错误:', error);
                updateProgress(0);
                showStatus(`加载失败: ${error.message}`, 'error');
                
                // 如果文件不存在，提示用户
                if (error.message.includes('文件不存在')) {
                    showStatus(`请先运行 combine_probability.js 生成 ${currentPeriod}期_web.json 文件`, 'error');
                }
                
                return null;
            }
        }
        

        
        // 从概率字符串中提取数字（如"45.68%" -> 0.4568）（保留用于可能的数据转换）
        function parseProbability(probStr) {
            if (typeof probStr === 'number') return probStr;
            if (typeof probStr === 'string') {
                const match = probStr.match(/(\d+\.?\d*)/);
                return match ? parseFloat(match[1]) / 100 : 0;
            }
            return 0;
        }
        
        // 显示计算结果
        function displayResults() {
            if (!webData || !webData.计算结果 || webData.计算结果.length === 0) {
                resultsContainer.innerHTML = `
                    <p style="text-align: center; opacity: 0.7; padding: 40px;">
                        暂无数据，请先加载Web JSON数据
                    </p>
                `;
                return;
            }
            
            let html = `
                <div style="margin-bottom: 30px; padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 12px; border-left: 4px solid #00bcd4;">
                    <h3 style="color: #00bcd4; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-info-circle"></i> 数据信息
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
                        <div>
                            <p style="margin-bottom: 5px; opacity: 0.8; font-size: 0.9em;">期数</p>
                            <p style="font-size: 1.2em; font-weight: 600;">${webData.期数 || '未知'}</p>
                        </div>

                        <div>
                            <p style="margin-bottom: 5px; opacity: 0.8; font-size: 0.9em;">生成时间</p>
                            <p>${webData.生成时间 ? new Date(webData.生成时间).toLocaleString() : '未知'}</p>
                        </div>

                        <div>
                            <p style="margin-bottom: 5px; opacity: 0.8; font-size: 0.9em;">数据来源</p>
                            <p style="word-break: break-all;">${webData.数据来源 ? `${webData.数据来源.基础预测文件}<br>${webData.数据来源.高级预测文件}` : 'web.json文件'}</p>
                        </div>
                        <div>
                            <p style="margin-bottom: 5px; opacity: 0.8; font-size: 0.9em;">加权规则</p>
                            <p>${webData.加权规则 || '基础预测概率 + 高级预测概率'}</p>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #00bcd4; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-futbol"></i> 比赛预测详情 (${webData.计算结果.length} 场)
                    </h3>
            `;
            
            // 显示每场比赛的详细卡片
            webData.计算结果.forEach((match, index) => {
                const winPercent = (match.合并概率.胜 * 100).toFixed(1);
                const drawPercent = (match.合并概率.平 * 100).toFixed(1);
                const losePercent = (match.合并概率.负 * 100).toFixed(1);
                const basicWinPercent = (match.基础预测概率.胜 * 100).toFixed(1);
                const basicDrawPercent = (match.基础预测概率.平 * 100).toFixed(1);
                const basicLosePercent = (match.基础预测概率.负 * 100).toFixed(1);
                const advancedWinPercent = (match.高级预测概率.胜 * 100).toFixed(1);
                const advancedDrawPercent = (match.高级预测概率.平 * 100).toFixed(1);
                const advancedLosePercent = (match.高级预测概率.负 * 100).toFixed(1);
                
                const resultClass = `result-${match.预测结果}`;
                const resultText = match.预测结果 === 3 ? '主胜(3)' : match.预测结果 === 1 ? '平(1)' : '客胜(0)';
                const resultColor = match.预测结果 === 3 ? '#4caf50' : match.预测结果 === 1 ? '#ff9800' : '#f44336';
                
                html += `
                    <div style="margin-bottom: 30px; padding: 25px; background: rgba(255, 255, 255, 0.03); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                        <!-- 比赛基本信息 -->
                        <div style="margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <h4 style="color: #00bcd4; margin-bottom: 5px;">
                                        第 ${match.场次} 场 · ${match.联赛}
                                    </h4>
                                    <p style="opacity: 0.8; font-size: 0.9em;">
                                        <i class="far fa-clock"></i> ${match.比赛时间}
                                    </p>
                                </div>
                                <div style="background: ${resultColor}20; padding: 8px 16px; border-radius: 20px; border: 1px solid ${resultColor}40;">
                                    <span class="${resultClass}" style="font-weight: 600; font-size: 1.1em;">${resultText}</span>
                                </div>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                                <div style="text-align: center; flex: 1;">
                                    <p style="font-size: 1.5em; font-weight: 600; color: #00bcd4;">${match.主队}</p>
                                    <p style="opacity: 0.8; font-size: 0.9em;">主队</p>
                                </div>
                                <div style="text-align: center; margin: 0 20px;">
                                    <p style="font-size: 1.2em; opacity: 0.7;">VS</p>
                                </div>
                                <div style="text-align: center; flex: 1;">
                                    <p style="font-size: 1.5em; font-weight: 600; color: #ff9800;">${match.客队}</p>
                                    <p style="opacity: 0.8; font-size: 0.9em;">客队</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 共同对手实力分部分 -->
                        ${match.共同对手实力分 ? `
                        <div style="margin-top: 30px; padding-top: 25px; border-top: 2px solid rgba(255, 255, 255, 0.1);">
                            <h5 style="color: #bbdefb; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-handshake"></i> 共同对手实力分
                            </h5>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                                <!-- 总实力分 -->
                                <div style="padding: 15px; background: rgba(255, 193, 7, 0.05); border-radius: 8px; border-left: 3px solid #ffc107;">
                                    <h6 style="color: #ffc107; margin-bottom: 10px; font-size: 0.95em;">
                                        <i class="fas fa-star"></i> 总实力分
                                    </h6>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span>主队总实力分:</span>
                                        <span style="font-weight: 600;">${match.共同对手实力分.主队总实力分.toFixed(3)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span>客队总实力分:</span>
                                        <span style="font-weight: 600;">${match.共同对手实力分.客队总实力分.toFixed(3)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>共同对手数:</span>
                                        <span style="font-weight: 600;">${match.共同对手实力分.共同对手数}</span>
                                    </div>
                                </div>
                                
                                <!-- 相对实力比 -->
                                <div style="padding: 15px; background: rgba(156, 39, 176, 0.05); border-radius: 8px; border-left: 3px solid #9c27b0;">
                                    <h6 style="color: #9c27b0; margin-bottom: 10px; font-size: 0.95em;">
                                        <i class="fas fa-balance-scale-left"></i> 相对实力比
                                    </h6>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span>主队相对实力比:</span>
                                        <span style="font-weight: 600;">${(match.共同对手实力分.主队相对实力比 * 100).toFixed(1)}%</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span>客队相对实力比:</span>
                                        <span style="font-weight: 600;">${(match.共同对手实力分.客队相对实力比 * 100).toFixed(1)}%</span>
                                    </div>
                                    <div style="margin-top: 15px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                            <span style="font-size: 0.9em; opacity: 0.8;">实力对比:</span>
                                        </div>
                                        <div style="height: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 4px; overflow: hidden;">
                                            <div style="height: 100%; width: ${match.共同对手实力分.主队相对实力比 * 100}%; background: linear-gradient(90deg, #ffc107, #ff9800); border-radius: 4px 0 0 4px;"></div>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                                            <span style="font-size: 0.85em; opacity: 0.8;">主队</span>
                                            <span style="font-size: 0.85em; opacity: 0.8;">客队</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- 概率数据部分 -->
                        <div style="margin-bottom: 25px;">
                            <h5 style="color: #bbdefb; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-chart-pie"></i> 概率分析
                            </h5>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                                <!-- 基础预测概率 -->
                                <div style="padding: 15px; background: rgba(0, 188, 212, 0.05); border-radius: 8px; border-left: 3px solid #00bcd4;">
                                    <h6 style="color: #00bcd4; margin-bottom: 10px; font-size: 0.95em;">
                                        <i class="fas fa-calculator"></i> 基础预测概率
                                    </h6>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span>主胜:</span>
                                        <span style="font-weight: 600;">${basicWinPercent}%</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span>平:</span>
                                        <span style="font-weight: 600;">${basicDrawPercent}%</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>客胜:</span>
                                        <span style="font-weight: 600;">${basicLosePercent}%</span>
                                    </div>
                                </div>
                                
                                <!-- 高级预测概率 -->
                                <div style="padding: 15px; background: rgba(142, 36, 170, 0.05); border-radius: 8px; border-left: 3px solid #8e24aa;">
                                    <h6 style="color: #8e24aa; margin-bottom: 10px; font-size: 0.95em;">
                                        <i class="fas fa-chart-line"></i> 高级预测概率
                                    </h6>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span>主胜:</span>
                                        <span style="font-weight: 600;">${advancedWinPercent}%</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span>平:</span>
                                        <span style="font-weight: 600;">${advancedDrawPercent}%</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>客胜:</span>
                                        <span style="font-weight: 600;">${advancedLosePercent}%</span>
                                    </div>
                                </div>
                                
                                <!-- 合并概率 -->
                                <div style="padding: 15px; background: rgba(76, 175, 80, 0.05); border-radius: 8px; border-left: 3px solid #4caf50;">
                                    <h6 style="color: #4caf50; margin-bottom: 10px; font-size: 0.95em;">
                                        <i class="fas fa-balance-scale"></i> 合并概率
                                    </h6>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span>主胜:</span>
                                        <span style="font-weight: 600; font-size: 1.1em;">${winPercent}%</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span>平:</span>
                                        <span style="font-weight: 600; font-size: 1.1em;">${drawPercent}%</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>客胜:</span>
                                        <span style="font-weight: 600; font-size: 1.1em;">${losePercent}%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 详细数据部分 - 有间隔 -->
                        <div style="margin-top: 30px; padding-top: 25px; border-top: 2px solid rgba(255, 255, 255, 0.1);">
                            <h5 style="color: #bbdefb; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-chart-bar"></i> 详细数据
                            </h5>
                `;
                
                // 显示详细数据
                if (match.预测详细数据 && Object.keys(match.预测详细数据).length > 0) {
                    html += `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">`;
                    
                    // 基础数据
                    if (match.预测详细数据.基础数据) {
                        html += `
                            <div style="padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 8px;">
                                <h6 style="color: #00bcd4; margin-bottom: 10px; font-size: 0.9em;">基础数据</h6>
                                <div style="font-size: 0.9em;">
                        `;
                        for (const [key, value] of Object.entries(match.预测详细数据.基础数据)) {
                            html += `<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span style="opacity: 0.8;">${key}:</span>
                                        <span>${value}</span>
                                    </div>`;
                        }
                        html += `</div></div>`;
                    }
                    
                    // 攻防效率
                    if (match.预测详细数据.攻防效率) {
                        html += `
                            <div style="padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 8px;">
                                <h6 style="color: #8e24aa; margin-bottom: 10px; font-size: 0.9em;">攻防效率</h6>
                                <div style="font-size: 0.9em;">
                        `;
                        for (const [key, value] of Object.entries(match.预测详细数据.攻防效率)) {
                            html += `<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span style="opacity: 0.8;">${key}:</span>
                                        <span>${value}</span>
                                    </div>`;
                        }
                        html += `</div></div>`;
                    }
                    
                    // 半全场节奏
                    if (match.预测详细数据.半全场节奏) {
                        html += `
                            <div style="padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 8px;">
                                <h6 style="color: #ff9800; margin-bottom: 10px; font-size: 0.9em;">半全场节奏</h6>
                                <div style="font-size: 0.9em;">
                        `;
                        for (const [key, value] of Object.entries(match.预测详细数据.半全场节奏)) {
                            html += `<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span style="opacity: 0.8;">${key}:</span>
                                        <span>${value}</span>
                                    </div>`;
                        }
                        html += `</div></div>`;
                    }
                    
                    // 其他详细数据
                    const otherSections = ['共同对手分析', '预期进球', '计算过程', '最终预测概率'];
                    otherSections.forEach(section => {
                        if (match.预测详细数据[section]) {
                            html += `
                                <div style="padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 8px;">
                                    <h6 style="color: #4caf50; margin-bottom: 10px; font-size: 0.9em;">${section}</h6>
                                    <div style="font-size: 0.9em;">
                            `;
                            // 处理嵌套对象
                            const renderObject = (obj, indent = 0) => {
                                let result = '';
                                for (const [key, value] of Object.entries(obj)) {
                                    if (typeof value === 'object' && value !== null) {
                                        result += `<div style="margin-left: ${indent * 10}px; margin-bottom: 5px;">
                                                    <span style="opacity: 0.8;">${key}:</span>
                                                </div>`;
                                        result += renderObject(value, indent + 1);
                                    } else {
                                        result += `<div style="display: flex; justify-content: space-between; margin-bottom: 5px; margin-left: ${indent * 10}px;">
                                                    <span style="opacity: 0.8;">${key}:</span>
                                                    <span>${value}</span>
                                                </div>`;
                                    }
                                }
                                return result;
                            };
                            
                            html += renderObject(match.预测详细数据[section]);
                            html += `</div></div>`;
                        }
                    });
                    
                    html += `</div>`;
                } else {
                    html += `<p style="text-align: center; opacity: 0.7; padding: 20px;">无详细数据</p>`;
                }
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            // 预测结果汇总
            const winCount = webData.计算结果.filter(m => m.预测结果 === 3).length;
            const drawCount = webData.计算结果.filter(m => m.预测结果 === 1).length;
            const loseCount = webData.计算结果.filter(m => m.预测结果 === 0).length;
            
            html += `
                </div>
                
                <div style="margin-top: 30px; padding: 25px; background: rgba(255, 255, 255, 0.05); border-radius: 12px; border-left: 4px solid #ff9800;">
                    <h3 style="color: #ff9800; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-chart-bar"></i> 预测结果汇总
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center; padding: 20px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; border: 1px solid rgba(76, 175, 80, 0.3);">
                            <p style="font-size: 2.5em; font-weight: 600; color: #4caf50;">${winCount}</p>
                            <p style="opacity: 0.9;">主胜(3)</p>
                        </div>
                        <div style="text-align: center; padding: 20px; background: rgba(255, 152, 0, 0.1); border-radius: 8px; border: 1px solid rgba(255, 152, 0, 0.3);">
                            <p style="font-size: 2.5em; font-weight: 600; color: #ff9800;">${drawCount}</p>
                            <p style="opacity: 0.9;">平(1)</p>
                        </div>
                        <div style="text-align: center; padding: 20px; background: rgba(244, 67, 54, 0.1); border-radius: 8px; border: 1px solid rgba(244, 67, 54, 0.3);">
                            <p style="font-size: 2.5em; font-weight: 600; color: #f44336;">${loseCount}</p>
                            <p style="opacity: 0.9;">客胜(0)</p>
                        </div>
                        <div style="text-align: center; padding: 20px; background: rgba(33, 150, 243, 0.1); border-radius: 8px; border: 1px solid rgba(33, 150, 243, 0.3);">
                            <p style="font-size: 2.5em; font-weight: 600; color: #2196f3;">${webData.计算结果.length}</p>
                            <p style="opacity: 0.9;">总场次</p>
                        </div>
                    </div>
                </div>
            `;
            
            resultsContainer.innerHTML = html;
            downloadLink.style.display = 'inline-block';
        }
        
        // 生成下载链接
        function generateDownloadLink() {
            if (!webData) {
                showStatus('没有可下载的数据', 'error');
                return;
            }
            
            try {
                const jsonData = JSON.stringify(webData, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const period = webData.期数?.replace('期', '') || currentPeriod || '未知期数';
                downloadLink.href = url;
                downloadLink.download = `${period}期_web.json`;
                downloadLink.textContent = `下载Web数据 (${period}期_web.json)`;
                
                // 清理之前的URL
                setTimeout(() => URL.revokeObjectURL(url), 60000);
                
                showStatus('下载链接已生成，点击"下载JSON"按钮保存文件', 'success');
            } catch (error) {
                console.error('生成下载链接错误:', error);
                showStatus(`生成下载链接失败: ${error.message}`, 'error');
            }
        }
        
        // 事件监听器
        fetchPeriodBtn.addEventListener('click', fetchCurrentPeriod);
        
        loadWebDataBtn.addEventListener('click', async () => {
            const data = await loadWebData();
            if (data) {
                console.log('Web数据加载成功:', data);
            }
        });
        
        downloadBtn.addEventListener('click', () => {
            window.location.href = './list.html';
        });
        
        // 期数输入框支持回车键
        periodInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const inputValue = periodInput.value.trim();
                if (inputValue) {
                    // 提取数字部分（例如从"26027期"中提取"26027"）
                    const periodMatch = inputValue.match(/\d+/);
                    if (periodMatch) {
                        currentPeriod = periodMatch[0];
                    } else {
                        currentPeriod = inputValue;
                    }
                    showStatus(`已手动设置期数为: ${currentPeriod}期`, 'info');
                    // 自动加载数据
                    setTimeout(() => {
                        loadWebDataBtn.click();
                    }, 300);
                }
            }
        });
        
        // 期数输入框失去焦点时更新期数（不自动加载）
        periodInput.addEventListener('blur', () => {
            const inputValue = periodInput.value.trim();
            if (inputValue) {
                // 提取数字部分（例如从"26027期"中提取"26027"）
                const periodMatch = inputValue.match(/\d+/);
                if (periodMatch) {
                    currentPeriod = periodMatch[0];
                } else {
                    currentPeriod = inputValue;
                }
                showStatus(`已更新期数为: ${currentPeriod}期`, 'info');
            }
        });
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            showStatus('Web数据查看器已加载完成，正在自动获取期数...', 'info');
            updateProgress(0);
            
            // 尝试自动获取期数（获取后会自动加载web.json数据）
            fetchCurrentPeriod();
        });
        

    </script>
</body>
</html>
